import marked from 'marked'
import { link_renderer } from '@sveltejs/site-kit/utils/markdown.js';
import { highlight } from 'highlight';

const renderer = new marked.Renderer()
renderer.link = link_renderer
renderer.code = highlight
renderer.list = (body, ordered, start) => {
    if(!ordered){
        return `
            <ul style='list-style-type: square; list-style-position: inside;'>
                ${body}
            </ul>
        `
    }
    if(ordered){
        return `
            <ol style='list-style-type: decimal; list-style-position: inside;'>
                ${body}
            </ol>
        `
    }
}

marked.setOptions({
    renderer: renderer,
    breaks: true
})

export function parseMarkdown(markdown) {
    return marked(
        markdown.replace(/^\t+/gm, match => match.split('\t').join('  '))
        .replace(/^\n+/gm, match => match.split('\n').join('<br /> \n')),
        { renderer }
    )
}

export function usernameCoerce(string){
    if(string){
        return string.toLowerCase().replace(' ', '')
    } else {
        return ''
    }
}

export function initialCaps(string){
    if(string){
        return string.charAt(0).toUpperCase() + string.slice(1)
    } else {
        return ''
    }
}

export function get(endpoint) {
    return fetch(endpoint, {
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(r => r.json())
}

export function post(endpoint, data) {
    return fetch(endpoint, {
        method: 'POST',
        credentials: 'include',
        body: JSON.stringify(data),
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(r => r.json())
}